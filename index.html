<!DOCTYPE html>
<meta charset="utf-8">
<meta 
     name='viewport' 
     content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' 
/>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highcharts/8.1.1/css/highcharts.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/css/select2.min.css" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/8.1.1/highcharts.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.1.0-beta.1/js/select2.min.js"></script>

<style>
	.grafik {
		width: 100%;
	} 
.select2-dropdown li {
    background-image: none !important;
   }
   #muni_sel {
	   width: 95%;
   }
</style>

<select id="muni_sel"></select>
<div id="vsechny" class="grafik"></div>

<div id="brno" class="grafik"></div>

<script>
let host = 'https://data.irozhlas.cz/covid-rud/'
if (location.hostname === 'localhost') {
  host = 'http://localhost/covid-rud/'
}

function draw(did, rec) {
	Highcharts.setOptions({
		lang: {
			numericSymbols: ['tis.', 'mil.', 'mld.', 'T', 'P', 'E']
		}
	})
	Highcharts.chart(did, {
		chart: {
			type: 'column',
			animation: false
		},
		title: {
			text: `${rec[0]} (${rec[1]})`
		},
		subtitle: {
			text: 'rozdíl v příjmech ze sdílených daní'
		},
		xAxis: {
			categories: [' odhad 2020 před koronavirem', 'odhad 2020 po koronaviru']
		},
		yAxis: {
			min: 0,
			title: {
				text: 'příjmy obce z daní v Kč'
			},
		},
		credits: {
			text: 'SMS ČR',
			href: 'https://www.smscr.cz/kalkulacka/rud/'
		},
		legend: {
			align: 'center',
			verticalAlign: 'bottom',
			floating: false,
			backgroundColor: 'white',
			borderColor: '#CCC',
			borderWidth: 1,
			shadow: false
		},
		tooltip: {
			headerFormat: '<b>{point.x}</b><br/>',
			pointFormat: '{series.name}: {point.y}<br/>celkem: {point.stackTotal}'
		},
		plotOptions: {
			column: {
				stacking: 'normal',
				dataLabels: {
					enabled: false
				}
			}
		},
		series: [{
			name: '1200 korun na obyvatele',
			data: [0, rec[2]],
			color: '#de2d26' 
		}, {
			name: 'plánované příjmy',
			data: [rec[4], rec[4] - rec[3]],
			color: '#3182bd',
		}]
	})
}

fetch(host + 'tools/mapa.json')
  .then(response => response.json())
  .then(data => {
	let selCont = ``
	data.forEach(rec => {
		selCont += `<option value="${rec[0]}_${rec[1]}">${rec[0]} (${rec[1]})</option>`
	})
	document.getElementById('muni_sel').innerHTML = selCont

	$(document).ready(function() {
		const sl = $('#muni_sel').select2({
			minimumInputLength: 2, 
			language: {
				inputTooShort: function () {
    				return "Napište aspoň 2 znaky...";
  				}
			}
		})
		sl.val('Praha_Praha')
		sl.trigger('change')
		sl.on('change', function(e) {
			const selected = $('#muni_sel').select2('data')[0].id.split('_')
			draw('vsechny', data.find(e => (e[0] == selected[0]) & (e[1] == selected[1])))

			// gacka
			if (typeof ga === 'function') {
    			console.log('Loaded :'+ ga)
				ga('send', 'event', 'vizualizace', 'graf', 'select_obce')
  			} else {
    			console.log('GA nevidno')
  			}
		})
	})

	//draw('vsechny', data.find(e => (e[0] == 'Praha') & (e[1] == 'Praha')))

	// divy pro další obce, doplnit obec a okres
	draw('brno', data.find(e => (e[0] == 'Brno') & (e[1] == 'Brno-město')))
})
</script>